### Основые команды
Проект завёрнут в docker, запускается через `docker-compose up`.  
Запуск тестов: `docker-compose exec web ./manage.py test`
Создать тестовые данные: `docker-compose exec web ./manage.py create_test_data`


### API сервиса  
`GET http://localhost:8000/api/offers/` – Список доступных предложений. Видно только партнёрам.  
`GET http://localhost:8000/api/offers/1/` – Детальная информация по предложению. Партнёры могу просматривать все актуальные предложения. Кредитная организация может просматривать только свои предложения.  

`GET http://localhost:8000/api/customers/` – Список анкет клиентов. Доступно для просмотра только партнёрам. Партнёры видят только свои анкеты.  
`GET http://localhost:8000/api/customers/1/` – Детальный просмотр анкеты клиента. Партнёры могут просматривать только свои анкеты. Кредитные организации могут просматривать анкету только в том случае, если от этой анкеты есть заявка на предложение этой кредитной организации.

`GET http://localhost:8000/api/applications/` – Список заявок. Партнёры видят свои заявки. Кредитные организации -- свои.
`POST http://localhost:8000/api/applications/` – Партнёр может отправить свою анкету клиента на рассмотрение в кредитную организацию.
Формать запроса:
```
{
    "customer_id": <customer_id>,
    "lender_id": <lender_id> | "all"
}
```
Если в параметре `lender_id` указано значение `"all"`, то заявка отправляется на рассмотрение во все кредитные организации. Для сопоставления данной анкеты со всеми предложениями создаётся отложенная задача.
Если партнёр подаёт заявку в конкретную организацию, то метод возвращает:  
- список созданных заявок, если у кредитной организации нашлись подходящие предложения;  
- если подходящие предложения не нашлись, то возвращает сообщение о том, что для данной анкеты у этой организации подходящих предложений нет;  

`GET http://localhost:8000/api/applications/1/` – Детальный просмотр заявки. Партнёры видят свои заявки. Кредитные организации -- свои.
`PATCH http://localhost:8000/api/applications/1/` – Через этот метод кредитная организация может менять статус заявки. Формат запроса: 
```
{
    "status": <status_id>
}
```
где `status_id`:
1 — новая (значение по умолчанию)  
2 — отправлена    
3 — получена  
4 — одобрено   
5 — отказано  
6 — выдано

### Подбор заявок
Система сама каждую минуту (настройка в `unicom.celery`) сопоставляет анкеты клиентов. Если находит подходящие, то автоматически создаёт заявки.
Помимо этого партнёр может сам через API отправлять выбранную анкету клиента в определённую кредитную организацию, или во все.
У анкеты клиента есть специальная настройка: Режим создания заявок. Это список со значениями `manual` и `auto`. Если в этом списке есть значение `auto`, то анкета участвует в автоматическом сопоставлении. Если есть значение `manual`, то эту анкету можно "вручную" отправлять на рассмотрение через API. При создании анкеты клиента через API значение по умолочанию: `('manual', 'auto')`, т.е. заявки создаются обоими способами.


### Комментарии 
* Предполагается, что не может быть созданно много заявок с одной анкеты на одно и то же предложение. Другими словами, у модели `Application` выставлен параметр `unique_together = ('lender_offer', 'customer')`.
* Форма авторизации: [http://localhost:8000/login/](http://localhost:8000/login/)
* Разлогиниться можно при переходе на url: [http://localhost:8000/logout/](http://localhost:8000/logout/)
* Коммандой `./manage.py create_test_data` создаются следующие тестовые пользователи:
    - Партнёры:
        * username: `Partner 1`  
        password: `user1_partner`  

        * username: `Partner 2`  
        password: `user2_partner`  

    - Кредитые организации:
        * username: `Lender 1`
        password: `user3_lender`

        * username: `Lender 2`
        password: `user4_lender`

    У них уже есть предсозданные анкета клиентов и предложения.  

* Создать администратора: `docker-compose exec web ./manage.py createsuperuser`  
    Чтобы администратору стало доступно API, нужно:
    1. Добавить его в группы "Партнёры" и "Кредитные организации" через админку.
    2. Создать для него партнёра через админку: [http://localhost:8000/admin/partners/partner/add/](http://localhost:8000/admin/partners/partner/add/)
    3. Создать для него кредитную организацию через админку: [http://localhost:8000/admin/lenders/lender/add/](http://localhost:8000/admin/lenders/lender/add/)
